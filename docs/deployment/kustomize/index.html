<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.89.4"><meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Kustomize | Australian Imaging Service</title>
<meta name=description content><meta property="og:title" content="Kustomize">
<meta property="og:description" content="Using Kustomize as a Post renderer for the AIS XNAT Helm Chart Kustomize Using a Helm Chart is a pretty awesome way to deploy Kubernetes infrastructure in a neatly packaged, release versioned way.
They can be updated from the upstream repo with a single line of code and for any customisations you want to add into the deployment you specify it in a values.yaml file.
Or at least that&rsquo;s how it should work.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://australian-imaging-service.github.io/docs/deployment/kustomize/"><meta property="article:section" content="docs">
<meta itemprop=name content="Kustomize">
<meta itemprop=description content="Using Kustomize as a Post renderer for the AIS XNAT Helm Chart Kustomize Using a Helm Chart is a pretty awesome way to deploy Kubernetes infrastructure in a neatly packaged, release versioned way.
They can be updated from the upstream repo with a single line of code and for any customisations you want to add into the deployment you specify it in a values.yaml file.
Or at least that&rsquo;s how it should work.">
<meta itemprop=wordCount content="1774">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Kustomize">
<meta name=twitter:description content="Using Kustomize as a Post renderer for the AIS XNAT Helm Chart Kustomize Using a Helm Chart is a pretty awesome way to deploy Kubernetes infrastructure in a neatly packaged, release versioned way.
They can be updated from the upstream repo with a single line of code and for any customisations you want to add into the deployment you specify it in a values.yaml file.
Or at least that&rsquo;s how it should work.">
<link rel=preload href=/scss/main.min.0e2d2f1aad30144f0d0ed4d049501e36226838b2c829c421afa864b6a3c63911.css as=style>
<link href=/scss/main.min.0e2d2f1aad30144f0d0ed4d049501e36226838b2c829c421afa864b6a3c63911.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo></span><span class="text-uppercase font-weight-bold">Australian Imaging Service</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/ target=_blank><span class=active>Dev Documentation</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/user_docs/ target=_blank><span>User Documentation</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.7cff0a6db7d5b05d6199f1ba86c96496.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.7cff0a6db7d5b05d6199f1ba86c96496.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docs-li>
<a href=/docs/ title=Documentation class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-docs><span>Dev Documentation</span></a>
<ul class=ul-1>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsinstruments-li>
<a href=/docs/instruments/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstruments><span>Instruments</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstrumentsrc-milabsu-ct-li>
<a href=/docs/instruments/rc-milabsu-ct/ title="RC MILabsU-CT" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstrumentsrc-milabsu-ct><span>MILabs U-CT</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstruments3t-and-7t-mri-li>
<a href=/docs/instruments/3t-and-7t-mri/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstruments3t-and-7t-mri><span>MR Solutions 3T & 7T MRI</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsinstrumentssiemens-artis-pheno-li>
<a href=/docs/instruments/siemens-artis-pheno/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsinstrumentssiemens-artis-pheno><span>Siemens ARTIS pheno</span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsrepositories-li>
<a href=/docs/repositories/ title="Top level overview of the AIS repositories" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsrepositories><span>Repositories</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-docsdeployment-li>
<a href=/docs/deployment/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsdeployment><span>Deployment</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentalb-ingress-controller-li>
<a href=/docs/deployment/alb-ingress-controller/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentalb-ingress-controller><span>ALB Ingress Controller</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentazure-setup-full-li>
<a href=/docs/deployment/azure-setup-full/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentazure-setup-full><span>Azure Setup Full</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentistio-setup-li>
<a href=/docs/deployment/istio-setup/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentistio-setup><span>Istio Setup</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-docsdeploymentkustomize-li>
<a href=/docs/deployment/kustomize/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentkustomize><span class=td-sidebar-nav-active-item>Kustomize</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentlinode-setup-li>
<a href=/docs/deployment/linode-setup/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentlinode-setup><span>Linode setup</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdeploymentreadme-li>
<a href=/docs/deployment/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdeploymentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsdevelopment-li>
<a href=/docs/development/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsdevelopment><span>Development</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentcicd-li>
<a href=/docs/development/cicd/ title="Continuous Integration / Continuous Delivery" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentcicd><span>CI/CD</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentmacos-multipass-k8s-li>
<a href=/docs/development/macos-multipass-k8s/ title="Development workstation with Multipass on MacOS" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentmacos-multipass-k8s><span>MacOS: Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentnixos-minikube-li>
<a href=/docs/development/nixos-minikube/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentnixos-minikube><span>NixOS: Minikube</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentubuntu-microk8s-li>
<a href=/docs/development/ubuntu-microk8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentubuntu-microk8s><span>Ubuntu: microk8s</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentwindows10-multipass-k8s-li>
<a href=/docs/development/windows10-multipass-k8s/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentwindows10-multipass-k8s><span>Windows 10: Multipass</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentxnat-chart-readme-li>
<a href=/docs/development/xnat-chart-readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentxnat-chart-readme><span>XNAT chart README</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentreferences-li>
<a href=/docs/development/references/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentreferences><span>References</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsdevelopmentreadme-li>
<a href=/docs/development/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsdevelopmentreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docsoperations-li>
<a href=/docs/operations/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docsoperations><span>Operations</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsaaf-integration-li>
<a href=/docs/operations/aaf-integration/ title="Integrating AAF with AIS Kubernetes XNAT Deployment" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsaaf-integration><span>AAF Integration</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsautoscaling-xnat-kubernetes-with-eks-li>
<a href=/docs/operations/autoscaling-xnat-kubernetes-with-eks/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsautoscaling-xnat-kubernetes-with-eks><span>Autoscaling XNAT on Kubernetes with EKS</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsdocker-swarm-with-xnat-li>
<a href=/docs/operations/docker-swarm-with-xnat/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsdocker-swarm-with-xnat><span>Docker Swarm with XNAT</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsexternal-pgsql-db-connection-li>
<a href=/docs/operations/external-pgsql-db-connection/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsexternal-pgsql-db-connection><span>External PGSQL DB Connection</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsrecommendations-li>
<a href=/docs/operations/recommendations/ title="Operational recommendations" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrecommendations><span>Recommendations</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docsoperationsreadme-li>
<a href=/docs/operations/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docsoperationsreadme><span></span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributing-li>
<a href=/docs/contributing/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributing><span>Contributing</span></a>
<ul class="ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-docscontributingdocumentation-li>
<a href=/docs/contributing/documentation/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-docscontributingdocumentation><span>Documentation</span></a>
<ul class="ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingdocumentationshortcodes-li>
<a href=/docs/contributing/documentation/shortcodes/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingdocumentationshortcodes><span>Shortcodes</span></a>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingnew-repo-li>
<a href=/docs/contributing/new-repo/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingnew-repo><span>Integrating a new repository</span></a>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-docscontributingreadme-li>
<a href=/docs/contributing/readme/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-docscontributingreadme><span></span></a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside>
<aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href=https://github.com/Australian-Imaging-Service/charts/edit/main/docs/Charts/Deployment/Kustomize.md target=_blank><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/Australian-Imaging-Service/charts/new/main/docs/Charts/Deployment/Kustomize.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i> Create child page</a>
<a href="https://github.com/Australian-Imaging-Service/charts/issues/new?title=Kustomize" target=_blank><i class="fab fa-github fa-fw"></i> Create documentation issue</a>
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li><a href=#kustomize>Kustomize</a></li>
<li><a href=#install-kustomize>Install Kustomize</a>
<ul>
<li><a href=#how-kustomize-works>How Kustomize works</a></li>
<li><a href=#1>1.</a></li>
<li><a href=#2>2.</a></li>
<li><a href=#3>3.</a></li>
<li><a href=#4>4.</a></li>
<li><a href=#5-deploy-the-helm-chart-with-kustomize-post-renderer>5. Deploy the Helm Chart with Kustomize post-renderer</a></li>
</ul>
</li>
<li><a href=#further-reading>Further Reading</a></li>
</ul>
</nav></div>
</aside>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/>Dev Documentation</a>
</li>
<li class=breadcrumb-item>
<a href=https://australian-imaging-service.github.io/docs/deployment/>Deployment</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://australian-imaging-service.github.io/docs/deployment/kustomize/>Kustomize</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>Kustomize</h1>
<header class=article-meta>
</header>
<h1 id=using-kustomize-as-a-post-renderer-for-the-ais-xnat-helm-chart>Using Kustomize as a Post renderer for the AIS XNAT Helm Chart</h1>
<h2 id=kustomize>Kustomize</h2>
<p>Using a Helm Chart is a pretty awesome way to deploy Kubernetes infrastructure in a neatly packaged, release versioned way.<br>
They can be updated from the upstream repo with a single line of code and for any customisations you want to add into the deployment you specify it in a values.yaml file.</p>
<p>Or at least that&rsquo;s how it should work. As Helm is based on templates, sometimes a value is hardcoded into the template and you can&rsquo;t change it in the values file.<br>
Your only option would have been to download the git repo that the Helm chart is based on, edit the template file in question and run it locally.</p>
<p>The problem with this approach is that when a new Helm Chart is released, you have to download the chart again and then apply all of your updates.<br>
This becomes cumbersome and negates the advantages of Helm.</p>
<p>Enter Kustomize. Kustomize can work in several ways but in this guide I will show you how to apply Kustomize as a post-renderer to update the template files to fit our environment.<br>
This allows you to continue to use the Helm Charts from the repo AND customise the Helm Chart templates to allow successful deployment.</p>
<p>You can read more about the Kustomize project here:<br>
<a href=https://kustomize.io/>https://kustomize.io/</a></p>
<h2 id=install-kustomize>Install Kustomize</h2>
<p>Kustomize can be run as its own program using the kustomize build command or built into kubectl using kubectl kustomize. We are going to use the kustomize standalone binary.</p>
<p>Go here to install:<br>
<a href=https://kubectl.docs.kubernetes.io/installation/kustomize/binaries/>https://kubectl.docs.kubernetes.io/installation/kustomize/binaries/</a></p>
<p>Direct install:</p>
<pre tabindex=0><code>curl -s &quot;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&quot;  | bash
</code></pre><p>This downloads to whatever directory you are in for whatever Operating System you are using. Copy it to /usr/local/bin to use it system wide:</p>
<pre tabindex=0><code>sudo cp kustomize /usr/local/bin
</code></pre><h3 id=how-kustomize-works>How Kustomize works</h3>
<p>When using Kustomize as a post renderer, Kustomize inputs all of the Helm Charts configuration data for a particular Chart in conjunction with the values file you specify with your cluster specific details and then amends the templates and applies them on the fly afterwards. This is why it is called a post renderer.</p>
<p>Let&rsquo;s break this down.</p>
<h3 id=1>1.</h3>
<p>In order to extract all of the Helm chart information, you can use the <em><strong>helm template</strong></em> command. In the case of our XNAT/AIS Helm chart, to extract all of this data into a file called all.yaml (can be any filename) you would run this command:</p>
<pre tabindex=0><code>helm template xnat ais/xnat &gt; all.yaml
</code></pre><p>You now have the complete configuration of your Helm Chart including all template files in one file - all.yaml.</p>
<h3 id=2>2.</h3>
<p>The next step is a kustomization.yaml file. This file must be called kustomization.yaml or Kustomize doesn&rsquo;t work.<br>
You create this and in it you specify your resources (inputs) - in our example, the resource will be all.yaml. The fantastic thing about Kustomize is you can add more resources in as well which combines with the Helm Chart to streamline deployment.</p>
<p>For instance, in my kustomization.yaml file I also specify a pv.yaml as another resource. This has information about creating Persistent Volumes for the XNAT deployment and creates the volumes with the deployment so I don&rsquo;t have to apply this separately. You can do this for any resources you want to add to your deployment not included in the Helm chart.<br>
Example using all.yaml and pv.yaml in the kustomization.yaml file:</p>
<pre tabindex=0><code>apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- all.yaml
- pv.yaml
</code></pre><p>The second part of the Kustomization.yaml file is where you specify the files that patch the templates you need to change.<br>
You need to specify Filename and path, name of the original template, type and version. It should be pointed out there are a lot of other ways to use Kustomize - you can read about them in some of the included articles at the end of this guide.</p>
<p>Example:</p>
<pre tabindex=0><code>patches:
- path: service-patch.yaml
  target:
    kind: Service
    name: xnat-xnat-web
    version: v1
</code></pre><p>In the above example, the file is service-patch.yaml and is in the same directory as kustomization.yaml, the name is xnat-xnat-web, the kind is Service and version is v1.<br>
Now lets look at the original service.yaml file to get a better idea. It is located in charts/releases/xnat/charts/xnat-web/templates/service.yaml:</p>
<pre tabindex=0><code>apiVersion: v1
kind: Service
metadata:
  name: {{ include &quot;xnat-web.fullname&quot; . }}
  labels:
    {{- include &quot;xnat-web.labels&quot; . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  #clusterIP: None
  ports:
    - port: {{ .Values.service.port }}
      targetPort: 8080
      protocol: TCP
      name: http
  selector:
    {{- include &quot;xnat-web.selectorLabels&quot; . | nindent 4 }}
  sessionAffinity: &quot;ClientIP&quot;
{{- if .Values.dicom_scp.recievers }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include &quot;xnat-web.fullname&quot; . }}-dicom-scp
  labels:
    {{- include &quot;xnat-web.labels&quot; . | nindent 4 }}
  {{- with .Values.dicom_scp.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.dicom_scp.serviceType | quote }}
  ports:
    {{- $serviceType := .Values.dicom_scp.serviceType }}
    {{- range .Values.dicom_scp.recievers }}
    - port: {{ .port }}
      targetPort: {{ .port }}
      {{- if and (eq $serviceType &quot;NodePort&quot;) .nodePort }}
      nodePort: {{ .nodePort }}
      {{- end }}
      {{- if and (eq $serviceType &quot;LoadBalancer&quot;) .loadBalancerIP }}
      loadBalancerIP: {{ .loadBalancerIP }}
      {{- end }}
    {{- end }}
  selector:
    {{- include &quot;xnat-web.selectorLabels&quot; . | nindent 4 }}
  sessionAffinity: &quot;ClientIP&quot;
{{- end }}
</code></pre><h3 id=3>3.</h3>
<p>The Patch file.<br>
OK, so let&rsquo;s have a look at our patch file and see what it is actually doing. Contents of service-patch.yaml:</p>
<pre tabindex=0><code>- op: remove
  path: &quot;/spec/sessionAffinity&quot;
</code></pre><p>Pretty simple really. <em><strong>- op: remove</strong></em> just removes whatever we tell it to in our service.yaml file. If we look through our file, we find <em><strong>spec</strong></em> and then under that we find <em><strong>sessionAffinity</strong></em> and then remove that.<br>
In this case if we remove all the other code to simplify things you get this:</p>
<pre tabindex=0><code>spec:
  sessionAffinity: &quot;ClientIP&quot;
</code></pre><p>As <em><strong>sessionAffinity</strong></em> is under spec by indentation it will remove the line:</p>
<pre tabindex=0><code>sessionAffinity: &quot;ClientIP&quot;
</code></pre><p>In this particular case my AWS Cluster needs Service Type to be NodePort so this particular line causes the XNAT deployment to fail, hence the requirement to remove it.<br>
OK so far so good. You can also use <em><strong>add</strong></em> and <em><strong>replace</strong></em> operations so let&rsquo;s try an add command example as that is slightly more complicated.</p>
<h4 id=add-and-replace-commands-example>Add and Replace commands example</h4>
<p>OK continuing with our AWS NodePort example we will add a redirect from port 80 to 443 in the Ingress and replace the existing entry. <br>
In order to do that we need to add a second host path to the charts/releases/xnat/charts/xnat-web/templates/ingress.yaml. Lets look at the original file:</p>
<pre tabindex=0><code>{{- if .Values.ingress.enabled -}}
{{- $fullName := include &quot;xnat-web.fullname&quot; . -}}
{{- $svcPort := .Values.service.port -}}
apiVersion: networking.k8s.io/v1beta1
{{- end }}
kind: Ingress
metadata:
  name: {{ $fullName }}
  labels:
    {{- include &quot;xnat-web.labels&quot; . | nindent 4 }}
  {{- with .Values.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $svcPort }}
          {{- end }}
    {{- end }}
  {{- end }}
</code></pre><p>This is what we need in our values file to be reflected in the ingress.yaml file:</p>
<pre tabindex=0><code>    hosts:
      - host: &quot;xnat.example.com&quot;
        paths: 
        - path: &quot;/*&quot;
          backend:
            serviceName: ssl-redirect
            servicePort: use-annotation
        - path: &quot;/*&quot;
          backend:
            serviceName: &quot;xnat-xnat-web&quot;
            servicePort: 80
</code></pre><p>And this is what we have at the moment in that file:</p>
<pre tabindex=0><code>  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            backend:
              serviceName: {{ $fullName }}
              servicePort: {{ $svcPort }}
          {{- end }}
</code></pre><p>As you can see, we are missing a second backend to allow the redirection from http to https.<br>
In kustomization.yaml add the following:</p>
<pre tabindex=0><code>- path: ingress-patch.yaml
  target:
    group: networking.k8s.io
    kind: Ingress
    name: xnat-xnat-web 
    version: v1beta1
</code></pre><p>The contents of ingress-patch.yaml:</p>
<pre tabindex=0><code>- op: replace
  path: /spec/rules/0/http/paths/0/backend/serviceName
  value: 'ssl-redirect'
- op: replace
  path: /spec/rules/0/http/paths/0/backend/servicePort
  value: 'use-annotation'
- op: add
  path: /spec/rules/0/http/paths/-
  value: 
    path: '/*'
    backend: 
      serviceName: 'xnat-xnat-web'
      servicePort: 80
</code></pre><p>OK, so let&rsquo;s break this down. The top command replaces this:</p>
<pre tabindex=0><code>serviceName: {{ $fullName }}
</code></pre><p>In this path:</p>
<pre tabindex=0><code>  rules:
      http:
        paths:
            backend:
</code></pre><p>With a hardcoded ServiceName value:</p>
<pre tabindex=0><code>serviceName: 'ssl-redirect'
</code></pre><p>I removed the extra lines to show you only the relevant section.</p>
<p>The second command replaces:</p>
<pre tabindex=0><code>servicePort: {{ $svcPort }}
</code></pre><p>In the same path, with the hardcoded value:</p>
<pre tabindex=0><code>servicePort: 'use-annotation'
</code></pre><p>Now for the add command.</p>
<pre tabindex=0><code>- op: add
  path: /spec/rules/0/http/paths/-
</code></pre><p>This will add the values in normal yaml syntax here:</p>
<pre tabindex=0><code>spec:
  rules:
      http:
        paths:
          - 
</code></pre><p>NB. I have removed irrelevant lines to simplify the example. If there were already two sets of path directive, replacing or adding to the second one would require this path:</p>
<pre tabindex=0><code>path: /spec/rules/1/http/paths/-
</code></pre><p>OK so the resultant transformation of the ingress.yaml file will change it to look like this:</p>
<pre tabindex=0><code>spec:
  rules:
      http:
        paths: 
          backend:
            serviceName: ssl-redirect
            servicePort: use-annotation
        - path: '/*'
          backend:
            serviceName: 'xnat-xnat-web'
            servicePort: 80

</code></pre><p>Let&rsquo;s look at our full kustomization.yaml file with resources and service and ingress patches.</p>
<pre tabindex=0><code>apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- all.yaml
- pv.yaml
patches:
- path: service-patch.yaml
  target:
    kind: Service
    name: xnat-xnat-web
    version: v1
- path: ingress-patch.yaml
  target:
    group: networking.k8s.io
    kind: Ingress
    name: xnat-xnat-web 
    version: v1beta1
</code></pre><p>We are now ready to apply our kustomizations!</p>
<h3 id=4>4.</h3>
<p>The script to bring this all together</p>
<p>Create a new fle called whatever you like - and make it executable, in my case we will call it hook.sh.</p>
<pre tabindex=0><code>vi hook.sh
chmod 755 hook.sh
</code></pre><p>The contents of hook.sh:</p>
<pre tabindex=0><code>#!/bin/bash
cat &lt;&amp;0 &gt; all.yaml
kustomize build &amp;&amp; rm all.yaml
</code></pre><p>This takes the contents of all.yaml and kustomizes it using the kustomization.yaml file with the resources and patches I have previously described. Finally, it deletes all.yaml.<br>
When you run <em><strong>kustomize build</strong></em> it will look for a file called kustomization.yaml to apply the transformations. As the kustomization.yaml file is in the same directory as hook.sh only the <em><strong>kustomize build</strong></em> command is needed, no further directive is required.</p>
<h3 id=5-deploy-the-helm-chart-with-kustomize-post-renderer>5. Deploy the Helm Chart with Kustomize post-renderer</h3>
<p>OK to bring it all together and upgrade the XNAT AIS helm chart with your values file as values.yaml in the namespace xnat, run this command:</p>
<pre tabindex=0><code>helm template xnat ais/xnat &gt; all.yaml &amp;&amp; helm upgrade xnat ais/xnat -i -f values.yaml -nxnat --post-renderer=./hook.sh
</code></pre><p>In this case, you need to make sure that the following files are in the same directory:</p>
<pre tabindex=0><code>values.yaml  
hook.sh  
kustomization.yaml  
ingress-patch.yaml
service-patch.yaml
pv.yaml
</code></pre><h2 id=further-reading>Further Reading</h2>
<p>There are a lot of configuration options for Kustomize and this just touched on the basics.<br>
Kustomize is also really useful for creating dev, staging and production implementations using the same chart. See these articles:</p>
<p><a href=https://austindewey.com/2020/07/27/patch-any-helm-chart-template-using-a-kustomize-post-renderer/>https://austindewey.com/2020/07/27/patch-any-helm-chart-template-using-a-kustomize-post-renderer/</a>
<a href=https://learnk8s.io/templating-yaml-with-code#using-templates-with-search-and-replace>https://learnk8s.io/templating-yaml-with-code#using-templates-with-search-and-replace</a></p>
<p>Nice Tutorial:<br>
<a href=https://povilasv.me/helm-kustomize-better-together/>https://povilasv.me/helm-kustomize-better-together/</a></p>
<div class="text-muted mt-5 pt-3 border-top">
Last modified
November 18, 2021
: <a href=https://github.com/Australian-Imaging-Service/charts/commit/ca8d796ea6da4716d39511f45fb8df24fdd818d4>Fix some style errors and typos for Kustomize documentation (ca8d796)</a>
</div>
</div>
</main>
</div>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>